# CU-00: Iniciar Sesi√≥n (Administrador / Cajero)

**Actor principal:** Administrador o Cajero  
**Tipo:** Soporte (precondici√≥n para CU-01‚Ä¶CU-05)  
**Prioridad:** Cr√≠tica  
**Iteraci√≥n:** I1 ‚Äì N√∫cleo Cliente + Sesiones  

---

## 1. Objetivo
Permitir que un usuario autorizado (Administrador o Cajero) acceda al sistema mediante credenciales v√°lidas, estableciendo su **rol y permisos** para operar funciones de caja, clientes y sesiones.

---

## 2. Descripci√≥n breve
El actor ingresa **usuario** y **contrase√±a**.  
El sistema valida credenciales, verifica estado del usuario (activo/no bloqueado), determina **rol** y crea una **sesi√≥n de aplicaci√≥n** con tiempo de expiraci√≥n.  
Si falla, informa el motivo (credenciales inv√°lidas, bloqueado, sin permisos).

---

## 3. Precondiciones
- El sistema est√° en l√≠nea y la conexi√≥n a base de datos es funcional.  
- El usuario existe, est√° **Activo** y cuenta con **rol** asignado (Administrador o Cajero).  
- La pol√≠tica de contrase√±as y bloqueo est√° configurada (intentos m√°ximos 3 y tiempo de bloqueo 5 minutos).

---

## 4. Flujo principal

| Paso | Actor / Sistema | Descripci√≥n |
|---|---|---|
| 1 | Actor | Abre la pantalla **Iniciar Sesi√≥n**. |
| 2 | Sistema | Presenta campos *Usuario*, *Contrase√±a*. |
| 3 | Actor | Ingresa credenciales y confirma **Acceder**. |
| 4 | Sistema | Valida usuario/contrase√±a (hash), estado **Activo** y **no bloqueado**. |
| 5 | Sistema | Determina **Rol** y **Permisos**; crea **Sesi√≥nApp** con expiraci√≥n e ID. |
| 6 | Sistema | Redirige a **Elegir consola/pc** (rol Cajero) o **Panel Admin** (rol Administrador). |
| 7 | Actor | Visualiza acceso concedido y contin√∫a con operaciones. |

---

## 5. Flujos alternos / excepciones

| C√≥digo | Descripci√≥n |
|---|---|
| **A1 ‚Äì Credenciales inv√°lidas** | Muestra *‚ÄúUsuario o contrase√±a incorrectos‚Äù* e incrementa contador de intentos fallidos. |
| **A2 ‚Äì Usuario bloqueado** | Si supera **3** intentos fallidos, marca **Bloqueado** (por 5 minutos o hasta desbloqueo admin). |
| **A3 ‚Äì Usuario inactivo** | Si `Activo = false`, muestra *‚ÄúUsuario inactivo, contacte al administrador‚Äù*. |
| **A4 ‚Äì Error de conexi√≥n** | Muestra *‚ÄúNo fue posible validar credenciales. Intente m√°s tarde‚Äù*. |
| **A5 ‚Äì Cambio obligatorio de contrase√±a** | Si es primer login/expiraci√≥n, redirige a **Cambiar Contrase√±a** antes de acceder. |

---

## 6. Inclusiones (include)
- **CU-___: Cerrar Sesi√≥n** (logout por men√∫ o inactividad).  
- **CU-___: Recuperar/Restablecer Contrase√±a** (si aplica).

---

## 7. Postcondiciones
- Se crea una **sesi√≥n de aplicaci√≥n** con: `UsuarioId`, `Rol`, `HoraInicio`, `ExpiraEn`.  
- El sistema habilita men√∫s y acciones seg√∫n **permisos del rol**.  
- Se registra en bit√°cora **login exitoso** (usuario, IP/equipo, fecha/hora).

---

## 8. Reglas de negocio relacionadas
- **RB1:** Pol√≠tica de contrase√±a (longitud 10 caracteres, minusculas, mayusculas y numeros).  
- **RB2:** **Bloqueo** tras `3` intentos fallidos durante `5` minutos.  
- **RB3:** **Timeout** de sesi√≥n por inactividad es de 15 min.  
- **RB4:** Auditor√≠a obligatoria de **intentos fallidos** y **logins**.  

---

## 9. Datos de prueba sugeridos

| Caso | Usuario | Contrase√±a | 2FA | Estado esperado |
|---|---|---|---|---|
| 1 | admin | Correcta | V√°lido | Acceso a Panel Admin |
| 2 | cajero01 | Correcta | ‚Äî | Acceso a Caja |
| 3 | cajero01 | Incorrecta | ‚Äî | Error A1; +1 intento fallido |
| 4 | cajero01 | Incorrecta (N veces) | ‚Äî | A2: Usuario bloqueado |
| 5 | cajero02(inactivo) | Correcta | ‚Äî | A3: Usuario inactivo |

---

## 10. Diagramas relacionados
- `actividad-login.puml`  
- `secuencia-login.puml`  

---

## 11. Notas t√©cnicas
- **Modelo sugerido**  
  - `Usuario(Id, Username, Hash, Activo, Rol, IntentosFallidos, BloqueadoHasta, RequiereCambioPwd)`  
  - `SesionApp(Id, UsuarioId, Inicio, Expira, UltimoMovimiento, Estado)`  
- **Seguridad**  
  - Contrase√±as con **hash + salt** (p. ej., PBKDF2/Argon2).  
  - Almacenar solo **hash**; nunca texto plano.  
  - Registrar `IP/host` en bit√°cora de acceso.  
- **UX Mensajes**  
  - üü¢ *Bienvenido, {Usuario}.*  
  - ‚ö†Ô∏è *Usuario o contrase√±a incorrectos.*  
  - üîí *Usuario bloqueado por seguridad.*  
  - üîÅ *Debe cambiar su contrase√±a para continuar.*  

---

**Autor:** Lic. en Matem√°ticas Juan Bernardo Lopez Acosta ‚Äî *Sistema de Gesti√≥n de Ciber (AppJB.Ciber)*  
**Fecha de redacci√≥n:** 22/oct/2025  
**Versi√≥n:** v1.0
